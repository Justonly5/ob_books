数据服务改造点：
1. 优化流式数据服务的负载均衡处理方式和策略，提升数据分发的效率，提升数据分发效率。

支持动态扩容

服务启停  轮起 

kafka consumer 在 pod 里均衡分配

kafka consumer 关闭时重新绑定 client 关系：


针对服务 试点  兼容已有方式 



1. 完善数据服务获取与Kafka的交互方式，降低异常率，增强服务的运行稳定性。

rebalance 问题。

如何解决 5min 的缓存带来的 leader 节点

调用频率低导致 rebalance 


2. 增强流式数据监控能力，提供kafka数据分布与堆积监控视图及告警能力
	配置调用方告警模板


4. 增强应用客户端（dsproxy）监控能力，提供客户端访问情况监控
     

	1. 消费组监控指标
	2. 消费者指标


5. 增强流数据服务的故障恢复能力，
   故障   通知机制    使用 kafka 消息通知
	   故障定义？ 
	   啥时候发送？
	   哪个环节节点发送？
   
   ~~完善流数据重发能力。~~

   


运维能力
 consumer 配置动态调整
 
 重置 consumer Offset




通过 MBean 可以获取 Kafka 客户端提供的监控指标。

Kafka 的消费者相关 MBean 主要在以下域中：

• `kafka.consumer:type=consumer-fetch-manager-metrics,client-id=<client-id>` :

	• records-lag-max: 最大滞后量。

	• records-consumed-rate: 每秒消费的消息数。

	• fetch-latency-avg: 消费者的平均拉取延迟。

	• fetch-latency-max: 消费者的最大拉取延迟。

• `kafka.consumer:type=consumer-coordinator-metrics,client-id=<client-id>` :

	• commit-latency-avg: 消费者提交的平均延迟。

	• commit-rate: 每秒提交的速率。

```JAVA
public class KafkaMetricsFetcher {

    public static void main(String[] args) {
        try {
            // 获取 JVM 的 MBean Server
            MBeanServer mbeanServer = ManagementFactory.getPlatformMBeanServer();
            // 查询 Kafka 消费者相关的 MBean
            Set<ObjectName> mbeans = mbeanServer.queryNames(
                    new ObjectName("kafka.consumer:type=consumer-fetch-manager-metrics,client-id=*"),
                    null);

            for (ObjectName mbean : mbeans) {
                System.out.println("MBean: " + mbean);
                // 获取某个具体的属性值，例如 records-lag-max
                Object lag = mbeanServer.getAttribute(mbean, "records-lag-max");
                System.out.println("records-lag-max: " + lag);
            }

        } catch (Exception e) {
            e.printStackTrace();

        }

    }

}
```


## [consumer monitoring](https://kafka.apache.org/27/documentation.html#consumer_monitoring)

The following metrics are available on consumer instances.

| Metric/Attribute name | Description                                                                                                            | Mbean name                                               |
| --------------------- | ---------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------- |
| time-between-poll-avg | The average delay between invocations of poll().                                                                       | kafka.consumer:type=consumer-metrics,client-id=([-.\w]+) |
| time-between-poll-max | The max delay between invocations of poll().                                                                           | kafka.consumer:type=consumer-metrics,client-id=([-.\w]+) |
| last-poll-seconds-ago | The number of seconds since the last poll() invocation.                                                                | kafka.consumer:type=consumer-metrics,client-id=([-.\w]+) |
| poll-idle-ratio-avg   | The average fraction of time the consumer's poll() is idle as opposed to waiting for the user code to process records. | kafka.consumer:type=consumer-metrics,client-id=([-.\w]+) |
|                       |                                                                                                                        |                                                          |

## [Consumer Group Metrics](https://kafka.apache.org/27/documentation.html#consumer_group_monitoring)

| Metric/Attribute name           | Description                                                                      | Mbean name                                                           |
| ------------------------------- | -------------------------------------------------------------------------------- | -------------------------------------------------------------------- |
| commit-latency-avg              | The average time taken for a commit request                                      | kafka.consumer:type=consumer-coordinator-metrics,client-id=([-.\w]+) |
| commit-latency-max              | The max time taken for a commit request                                          | kafka.consumer:type=consumer-coordinator-metrics,client-id=([-.\w]+) |
| commit-rate                     | The number of commit calls per second                                            | kafka.consumer:type=consumer-coordinator-metrics,client-id=([-.\w]+) |
| commit-total                    | The total number of commit calls                                                 | kafka.consumer:type=consumer-coordinator-metrics,client-id=([-.\w]+) |
| assigned-partitions             | The number of partitions currently assigned to this consumer                     | kafka.consumer:type=consumer-coordinator-metrics,client-id=([-.\w]+) |
| heartbeat-response-time-max     | The max time taken to receive a response to a heartbeat request                  | kafka.consumer:type=consumer-coordinator-metrics,client-id=([-.\w]+) |
| heartbeat-rate                  | The average number of heartbeats per second                                      | kafka.consumer:type=consumer-coordinator-metrics,client-id=([-.\w]+) |
| heartbeat-total                 | The total number of heartbeats                                                   | kafka.consumer:type=consumer-coordinator-metrics,client-id=([-.\w]+) |
| join-time-avg                   | The average time taken for a group rejoin                                        | kafka.consumer:type=consumer-coordinator-metrics,client-id=([-.\w]+) |
| join-time-max                   | The max time taken for a group rejoin                                            | kafka.consumer:type=consumer-coordinator-metrics,client-id=([-.\w]+) |
| join-rate                       | The number of group joins per second                                             | kafka.consumer:type=consumer-coordinator-metrics,client-id=([-.\w]+) |
| join-total                      | The total number of group joins                                                  | kafka.consumer:type=consumer-coordinator-metrics,client-id=([-.\w]+) |
| sync-time-avg                   | The average time taken for a group sync                                          | kafka.consumer:type=consumer-coordinator-metrics,client-id=([-.\w]+) |
| sync-time-max                   | The max time taken for a group sync                                              | kafka.consumer:type=consumer-coordinator-metrics,client-id=([-.\w]+) |
| sync-rate                       | The number of group syncs per second                                             | kafka.consumer:type=consumer-coordinator-metrics,client-id=([-.\w]+) |
| sync-total                      | The total number of group syncs                                                  | kafka.consumer:type=consumer-coordinator-metrics,client-id=([-.\w]+) |
| rebalance-latency-avg           | The average time taken for a group rebalance                                     | kafka.consumer:type=consumer-coordinator-metrics,client-id=([-.\w]+) |
| rebalance-latency-max           | The max time taken for a group rebalance                                         | kafka.consumer:type=consumer-coordinator-metrics,client-id=([-.\w]+) |
| rebalance-latency-total         | The total time taken for group rebalances so far                                 | kafka.consumer:type=consumer-coordinator-metrics,client-id=([-.\w]+) |
| rebalance-total                 | The total number of group rebalances participated                                | kafka.consumer:type=consumer-coordinator-metrics,client-id=([-.\w]+) |
| rebalance-rate-per-hour         | The number of group rebalance participated per hour                              | kafka.consumer:type=consumer-coordinator-metrics,client-id=([-.\w]+) |
| failed-rebalance-total          | The total number of failed group rebalances                                      | kafka.consumer:type=consumer-coordinator-metrics,client-id=([-.\w]+) |
| failed-rebalance-rate-per-hour  | The number of failed group rebalance event per hour                              | kafka.consumer:type=consumer-coordinator-metrics,client-id=([-.\w]+) |
| last-rebalance-seconds-ago      | The number of seconds since the last rebalance event                             | kafka.consumer:type=consumer-coordinator-metrics,client-id=([-.\w]+) |
| last-heartbeat-seconds-ago      | The number of seconds since the last controller heartbeat                        | kafka.consumer:type=consumer-coordinator-metrics,client-id=([-.\w]+) |
| partitions-revoked-latency-avg  | The average time taken by the on-partitions-revoked rebalance listener callback  | kafka.consumer:type=consumer-coordinator-metrics,client-id=([-.\w]+) |
| partitions-revoked-latency-max  | The max time taken by the on-partitions-revoked rebalance listener callback      | kafka.consumer:type=consumer-coordinator-metrics,client-id=([-.\w]+) |
| partitions-assigned-latency-avg | The average time taken by the on-partitions-assigned rebalance listener callback | kafka.consumer:type=consumer-coordinator-metrics,client-id=([-.\w]+) |
| partitions-assigned-latency-max | The max time taken by the on-partitions-assigned rebalance listener callback     | kafka.consumer:type=consumer-coordinator-metrics,client-id=([-.\w]+) |
| partitions-lost-latency-avg     | The average time taken by the on-partitions-lost rebalance listener callback     | kafka.consumer:type=consumer-coordinator-metrics,client-id=([-.\w]+) |
| partitions-lost-latency-max     | The max time taken by the on-partitions-lost rebalance listener callback         | kafka.consumer:type=consumer-coordinator-metrics,client-id=([-.\w]+) |
|                                 |                                                                                  |                                                                      |



## [Consumer Fetch Metrics](https://kafka.apache.org/27/documentation.html#consumer_fetch_monitoring)

### 消费者
kafka.consumer:type=consumer-fetch-manager-metrics,client-id="{client-id}"

| Attribute name          | Description                                                                     |
| ----------------------- | ------------------------------------------------------------------------------- |
| bytes-consumed-rate     | The average number of bytes consumed per second                                 |
| bytes-consumed-total    | The total number of bytes consumed                                              |
| fetch-latency-avg       | The average time taken for a fetch request.                                     |
| fetch-latency-max       | The max time taken for any fetch request.                                       |
| fetch-rate              | The number of fetch requests per second.                                        |
| fetch-size-avg          | The average number of bytes fetched per request                                 |
| fetch-size-max          | The maximum number of bytes fetched per request                                 |
| fetch-throttle-time-avg | The average throttle time in ms                                                 |
| fetch-throttle-time-max | The maximum throttle time in ms                                                 |
| fetch-total             | The total number of fetch requests.                                             |
| records-consumed-rate   | The average number of records consumed per second                               |
| records-consumed-total  | The total number of records consumed                                            |
| records-lag-max         | The maximum lag in terms of number of records for any partition in this window  |
| records-lead-min        | The minimum lead in terms of number of records for any partition in this window |
| records-per-request-avg | The average number of records in each request                                   |
### 消费者 + Topic
kafka.consumer:type=consumer-fetch-manager-metrics,client-id="{client-id}",topic="{topic}"

| Attribute name          | Description                                                   |
| ----------------------- | ------------------------------------------------------------- |
| bytes-consumed-rate     | The average number of bytes consumed per second for a topic   |
| bytes-consumed-total    | The total number of bytes consumed for a topic                |
| fetch-size-avg          | The average number of bytes fetched per request for a topic   |
| fetch-size-max          | The maximum number of bytes fetched per request for a topic   |
| records-consumed-rate   | The average number of records consumed per second for a topic |
| records-consumed-total  | The total number of records consumed for a topic              |
| records-per-request-avg | The average number of records in each request for a topic     |

### 消费者 + Topic + Partition
kafka.consumer:type=consumer-fetch-manager-metrics,partition="{partition}",topic="{topic}",client-id="{client-id}"

| Attribute name         | Description                                                              |
| ---------------------- | ------------------------------------------------------------------------ |
| preferred-read-replica | The current read replica for the partition, or -1 if reading from leader |
| records-lag            | The latest lag of the partition                                          |
| records-lag-avg        | The average lag of the partition                                         |
| records-lag-max        | The max lag of the partition                                             |
| records-lead           | The latest lead of the partition                                         |
| records-lead-avg       | The average lead of the partition                                        |
| records-lead-min       | The min lead of the partition                                            |
